---
name: uaa

releases:
  - name: uaa
    version: latest

instance_groups:
  - name: uaa
    instances: 1
    vm_type: common
    azs: [z1]
    stemcell: trusty
    networks:
      - name: public
        static_ips: [<%= @private_subnet[17] %>]
        default: [dns, gateway]
    jobs:
      - name: uaa_postgres
        release: uaa
        properties:
          postgres:
            port: 5524
            roles:
              - tag: admin
                name: uaaadmin
                password: ((db_password))
            databases:
              - tag: uaa
                name: uaadb
                citext: true
      - name: uaa
        release: uaa
        properties:
          uaa:
            url: <%= @values['oauth']['url'] %>
            jwt:
              policy:
                active_key_id: key-1
                keys:
                  key-1:
                    signingKey: ((uaa_signing_key))
            sslCertificate: ((uaa_cert))
          uaadb:
            address: 127.0.0.1
            databases:
              - name: uaadb
                tag: uaa
            db_scheme: postgresql
            port: 5524
            roles:
              - name: uaaadmin
                password: ((db_password))
                tag: admin

update:
  canaries: 1
  max_in_flight: 1
  serial: false
  canary_watch_time: 1000-60000
  update_watch_time: 1000-60000

stemcells:
  - alias: trusty
    name: ubuntu-trusty
    version: latest

variables:
  - name: db_password
    type: password
  - name: uaa_signing_key
    type: rsa
  - name: uaa_cert
    type: certificate
    options:
      ca: default_ca
      common_name: ((internal_ip))
      alternative_names: [((internal_ip))]
