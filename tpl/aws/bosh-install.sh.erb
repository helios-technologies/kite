#!/usr/bin/env bash

set -xe

# Create a new BOSH environment with Director
bosh create-env deployments/bosh/bosh_director.yml \
  --state=state.json \
  --vars-store=creds.yml \
  --vars-file=bosh_vars.yml \
  --var-file private_key=<%= @values['kite']['private_key_path'] %> \
  -o deployments/bosh/cpi.yml \
  -o deployments/bosh/jumpbox-user.yml

# Configure alias for the new environment
bosh alias-env <%= @values['bosh']['name'] %> \
  -e <%= @values['bosh']['static_ip'] %>  \
  --ca-cert <(bosh int ./creds.yml --path /director_ssl/ca)

# Get jumpbox user key
bosh int creds.yml --path /jumpbox_ssh/private_key > jumpbox.key
chmod 600 jumpbox.key

# Log into the newly created Director
export BOSH_CLIENT=admin
export BOSH_CLIENT_SECRET=`bosh int ./creds.yml --path /admin_password`
